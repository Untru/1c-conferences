name: üöÄ –°–±–æ—Ä–∫–∞ –∏ –¥–µ–ø–ª–æ–π —Å–∞–π—Ç–∞

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  update-navigation:
    name: üóÇÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üêç –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üóÇÔ∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        run: |
          python generate_nav.py

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        id: check-nav-changes
        run: |
          if [ -n "$(git status --porcelain mkdocs.yml)" ]; then
            echo "nav_changed=true" >> $GITHUB_OUTPUT
            echo "üìù –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"
            git diff mkdocs.yml
          else
            echo "nav_changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
          fi

      - name: üìù –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        if: steps.check-nav-changes.outputs.nav_changed == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add mkdocs.yml
          git commit -m "üóÇÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ [skip ci]"
          git push

  build:
    name: üî® –°–æ–±—Ä–∞—Ç—å —Å–∞–π—Ç
    runs-on: ubuntu-latest
    needs: update-navigation
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: üêç –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üóÇÔ∏è –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        run: |
          python generate_nav.py

      - name: üî® –°–æ–±—Ä–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
        run: |
          mkdocs build

      - name: üì¶ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site/

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥
        uses: actions/checkout@v4

      - name: üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Å–∞–π—Ç
        uses: actions/download-artifact@v4
        with:
          name: site
          path: site/

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true
          commit_message: "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —Å–∞–π—Ç–∞ [skip ci]"